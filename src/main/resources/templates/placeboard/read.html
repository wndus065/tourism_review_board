<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="layout/basic :: setContent(~{this::content} )">

	<th:block th:fragment="content">
		<body onload="loadCommentList()">
			<h2>placeboard Read Page</h2>

			<div class="row">

				<div class="col-7">
					<div class="form-group">
						<label>번호</label> <input type="text" class="form-control"
							name="no" th:value="${dto.no}" readonly>
					</div>

					<div class="form-group">
						<label>제목</label> <input type="text" class="form-control"
							name="title" th:value="${dto.title}" readonly>
					</div>
					<div class="form-group">
						<label>글 내용</label>
						<textarea class="form-control" rows="5" name="content" readonly>[[${dto.content}]]</textarea>
					</div>
					<div class="form-group">
						<label>글쓴이</label> <input type="text" class="form-control"
							name="writer" th:value="${dto.writer}" readonly>
					</div>
					<div class="form-group">
						<label>등록일</label> <input type="text" class="form-control"
							name="regDate"
							th:value="${#temporals.format(dto.regDate, 'yyyy/MM/dd HH:mm:ss')}"
							readonly>
					</div>
					<div class="form-group">
						<label>수정일</label> <input type="text" class="form-control"
							name="modDate"
							th:value="${#temporals.format(dto.modDate, 'yyyy/MM/dd HH:mm:ss')}"
							readonly>
					</div>

					<a th:href="@{/placeboard/modify(no = ${dto.no})}">
						<button type="button" class="btn btn-primary">수정</button>
					</a>

					<!-- 목록페이지 링크 수정 -->
					<a th:href="@{/placeboard/list(page=${page})}">
						<button type="button" class="btn btn-info">목록으로</button>
					</a>
				</div>
				<!-- 댓글 구현 하는 중 -->

				<div class="col-2">
					<section class="box text-style1" style="width: 500px">
						<div class="form-group" id="commentForm">
							<form>
								<input type="hidden" id="placeNo" name="placeNo"
									th:value="${dto.no}" /> <input type="hidden" id="writer"
									th:value="${session.id}" />
								<textarea id="comment" name="comment" placeholder="댓글을 입력하세요"></textarea>
								<select id="grade" name="grade">
									<option value="5">5점</option>
									<option value="4">4점</option>
									<option value="3">3점</option>
									<option value="2">2점</option>
									<option value="1">1점</option>
								</select>
								<button type="submit">등록</button>
							</form>

						</div>
						<hr>
						<div class="form-group" id="commentList">
							<div th:each="dto : ${commentList}">
							<div class="row">
								<div class="form-group col-10">
									<p>
										<strong>[[${dto.writer}]]</strong> ([[${dto.grade}]])
									</p>
									<p>[[${dto.comment}]]</p>
									<p style="color: gray">[[${#temporals.format(dto.regDate,
										'yyyy/MM/dd HH:mm:ss')}]]</p>
								</div>
								<div class="col-2">
									<button>
										<p>zz</p>
									</button>
									<button>
										<p>aa</p>
									</button>
								</div>
								<hr>
							</div></div>
						</div>


						<script>
					function updateCommentList(commentList) {
					    let commentHtml = '';
					    for (let i = 0; i < commentList.length; i++) {
					        const comment = commentList[i];
					        commentHtml += `<div class="form-group col-10">
					                            <p><strong>${comment.writer}</strong> : ${comment.grade}</p>
					                            <p>${comment.comment}</p>
					                            <p style="color: gray">${comment.regDate}</p>
					                        </div>
					                        <div class="col-2">
												<button><p>zz</p></button>
												<button><p>aa</p></button>
											</div>
					                        <hr>`;
					    }
					    $('#commentList').html(commentHtml);
					}
					
					// 페이지 로드 시 댓글 목록을 서버로부터 가져오는 함수 추가
					function loadCommentList() {
					  const placeNo = $("#placeNo").val();
					  $.ajax({
					    type: "GET",
					    url: "/comment/list",
					    data: { placeNo },
					    success: function (response) {
					      if (response.success) {
					        const commentList = response.data;
					        updateCommentList(commentList);
					      } else {
					        alert("댓글 목록을 가져오는데 실패했습니다.");
					      }
					    },
					    error: function () {
					      alert("댓글 목록을 가져오는데 실패했습니다.");
					    },
					  });
					}

					// 댓글 등록 이벤트 처리
					$(document).on("submit", "#commentForm form", function (event) {
					  event.preventDefault(); // 기본 이벤트 동작 방지

					  const placeNo = $("#placeNo").val();
					  const comment = $("#comment").val();
					  const grade = $("#grade").val();
					  const writer = $("#writer").val(); // writer 값을 읽어옵니다.
					  const data = { placeNo, writer, comment, grade };

					  $.ajax({
					    type: "POST",
					    url: "/comment/register",
					    data: data,
					    success: function (response) {
					      if (response.success) {
					        $("#comment").val(""); // 댓글 입력 필드 초기화
					        $("#grade").val("5"); // 평점 선택 필드 초기화
					        const commentList = response.data;
					        loadCommentList(); // 페이지 로드 시 서버로부터 댓글 목록을 가져옴
					      } else {
					        alert("댓글 등록에 실패했습니다.");
					      }
					    },
					    error: function () {
					      alert("댓글 등록에 실패했습니다.");
					    },
					  });
					});
					</script>
					</section>
				</div>
			</div>
	</th:block>

</th:block>